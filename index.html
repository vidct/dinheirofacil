<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Chat WebRTC</title>
<style>
body { background:#000; color:#0f0; font-family:sans-serif }
textarea { width:100%; height:120px }
</style>
</head>

<body>

<button onclick="criar()">CRIAR</button>
<button onclick="entrar()">ENTRAR</button>

<p>Código local:</p>
<textarea id="local"></textarea>

<p>Código remoto:</p>
<textarea id="remoto"></textarea>

<hr>

<div id="msgs"></div>
<input id="msg">
<button onclick="enviar()">Enviar</button>

<script>
// ===== INÍCIO =====

let pc;
let canal;
let criador = false;

function criar() {
  criador = true;
  pc = new RTCPeerConnection();

  canal = pc.createDataChannel("chat");
  canal.onmessage = e => msgs.innerHTML += e.data + "<br>";

  pc.onicecandidate = e => {
    if (!e.candidate)
      local.value = JSON.stringify(pc.localDescription);
  };

  pc.createOffer().then(o => pc.setLocalDescription(o));
}

function entrar() {
  const desc = JSON.parse(remoto.value);

  // SE NÃO EXISTE CONEXÃO, É O LADO B
  if (!pc) {
    pc = new RTCPeerConnection();

    pc.ondatachannel = e => {
      canal = e.channel;
      canal.onmessage = ev => msgs.innerHTML += ev.data + "<br>";
    };

    pc.onicecandidate = e => {
      if (!e.candidate)
        local.value = JSON.stringify(pc.localDescription);
    };

    pc.setRemoteDescription(desc).then(() =>
      pc.createAnswer().then(a => pc.setLocalDescription(a))
    );

  } else {
    // ✅ AQUI É O PASSO 9
    // NÃO CRIA NADA
    // NÃO GERA SDP
    // SÓ FINALIZA
    pc.setRemoteDescription(desc);
  }
}

function enviar() {
  canal.send(msg.value);
  msg.value = "";
}

// ===== FIM =====
</script>

</body>
</html>
