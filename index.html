<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Chat WebRTC Simples</title>

<style>
body {
  background: #000;
  color: #0f0;
  font-family: sans-serif;
}
textarea { width: 100%; height: 100px; }
</style>
</head>

<body>

<h2>Chat WebRTC (sem Firebase)</h2>

<button onclick="criar()">CRIAR</button>
<button onclick="entrar()">ENTRAR</button>

<p>Copie este código e mande:</p>
<textarea id="local"></textarea>

<p>Cole o código recebido:</p>
<textarea id="remoto"></textarea>

<hr>

<div id="incomingMessages"></div>

<input id="messageBox" placeholder="Mensagem">
<button id="sendButton">Enviar</button>

<script>
// ===== INÍCIO DO CÓDIGO WEBRTC =====

let pc;
let canal;

// cria conexão
function criar() {

  pc = new RTCPeerConnection();

  canal = pc.createDataChannel("chat");

  canal.onmessage = e => {
    incomingMessages.innerHTML += e.data + "<br>";
  };

  pc.onicecandidate = e => {
    if (!e.candidate) {
      local.value = JSON.stringify(pc.localDescription);
    }
  };

  pc.createOffer().then(o => pc.setLocalDescription(o));
}

// entra na conexão
function entrar() {

  pc = new RTCPeerConnection();

  pc.ondatachannel = e => {
    canal = e.channel;
    canal.onmessage = ev => {
      incomingMessages.innerHTML += ev.data + "<br>";
    };
  };

  pc.onicecandidate = e => {
    if (!e.candidate) {
      local.value = JSON.stringify(pc.localDescription);
    }
  };

  const offer = JSON.parse(remoto.value);
  pc.setRemoteDescription(offer);

  pc.createAnswer().then(a => pc.setLocalDescription(a));
}

// envia mensagem
sendButton.onclick = () => {
  canal.send(messageBox.value);
  messageBox.value = "";
};

// ===== FIM DO CÓDIGO WEBRTC =====
</script>

</body>
</html>
